generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum PlanTier {
  FREE
  BASIC
  PRO
  TEAM
}

enum ShareRole {
  OWNER
  CONTRIB
  VIEWER
  EDITOR
}

enum PaymentStatus {
  PENDING
  ACTIVE
  CANCELED
  FAILED
}

enum NotificationType {
  STAR
  FORK
  SHARE
  BILLING
  SYSTEM
}

model User {
  id                    String     @id @default(cuid())
  email                 String     @unique
  passwordHash          String?    @map("password_hash")
  name                  String?
  image                 String?
  bio                   String?    @db.Text
  planTier              PlanTier   @default(FREE) @map("plan_tier")
  apiToken              String?    @unique @map("api_token")
  emailVerified         DateTime?  @map("email_verified")
  referralCode          String     @unique @default(cuid()) @map("referral_code")
  referredById          String?    @map("referred_by_id")
  referralCredits       Int        @default(0) @map("referral_credits")
  paystackCustomerCode  String?    @map("paystack_customer_code")
  paystackSubscription  String?    @map("paystack_subscription")
  createdAt             DateTime   @default(now()) @map("created_at")
  updatedAt             DateTime   @updatedAt @map("updated_at")
  repos                 Repo[]
  envs                  Env[]
  shares                Share[]
  stars                 Star[]
  forks                 Fork[]
  auditLogs             AuditLog[]
  payments              Payment[]
  notifications         Notification[]
  followsByUser         Follow[]   @relation("follows_by_user")
  followedUsers         Follow[]   @relation("followed_users")
  referredBy            User?      @relation("user_referrals", fields: [referredById], references: [id])
  referredUsers         User[]     @relation("user_referrals")
  templatePurchases     TemplatePurchase[]
  accounts              Account[]
  sessions              Session[]
}

model Repo {
  id            String      @id @default(cuid())
  userId        String      @map("user_id")
  name          String
  slug          String
  repoPinHash   String?     @map("repo_pin_hash")
  description   String?     @db.Text
  readme        String?     @db.Text
  isPublic      Boolean     @default(false) @map("public")
  forkedFromId  String?     @map("forked_from_id")
  tags          String[]    @default([])
  starsCount    Int         @default(0) @map("stars_count")
  viewsCount    Int         @default(0) @map("views_count")
  defaultEnv    String      @default("development") @map("default_env")
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")
  owner         User        @relation(fields: [userId], references: [id])
  forkedFrom    Repo?       @relation("repo_forks", fields: [forkedFromId], references: [id])
  forks         Repo[]      @relation("repo_forks")
  envs          Env[]
  shares        Share[]
  stars         Star[]
  forkEvents    Fork[]
  auditLogs     AuditLog[]
  notifications Notification[]
  templates     Template[]

  @@unique([userId, slug])
  @@index([isPublic, starsCount])
  @@index([userId])
}

model Env {
  id          String    @id @default(cuid())
  repoId      String    @map("repo_id")
  userId      String    @map("user_id")
  environment String    @default("development")
  version     Int
  jsonBlob    String    @db.Text @map("json_blob")
  commitMsg   String    @map("commit_msg")
  diffSummary String?   @db.Text @map("diff_summary")
  createdAt   DateTime  @default(now()) @map("created_at")
  repo        Repo      @relation(fields: [repoId], references: [id])
  user        User      @relation(fields: [userId], references: [id])

  @@unique([repoId, environment, version])
  @@index([repoId, createdAt])
}

model Share {
  id          String    @id @default(cuid())
  repoId      String    @map("repo_id")
  userId      String?   @map("user_id")
  invitedById String    @map("invited_by_id")
  inviteEmail String?   @map("invite_email")
  role        ShareRole
  token       String?   @unique
  acceptedAt  DateTime? @map("accepted_at")
  expiresAt   DateTime? @map("expires_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  repo        Repo      @relation(fields: [repoId], references: [id])
  user        User?     @relation(fields: [userId], references: [id])

  @@unique([repoId, token])
  @@index([repoId])
  @@index([userId])
}

model Star {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  repoId    String   @map("repo_id")
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id])
  repo      Repo     @relation(fields: [repoId], references: [id])

  @@unique([userId, repoId])
  @@index([repoId])
}

model Fork {
  id             String   @id @default(cuid())
  userId         String   @map("user_id")
  repoId         String   @map("repo_id")
  originalRepoId String   @map("original_repo_id")
  createdAt      DateTime @default(now()) @map("created_at")
  user           User     @relation(fields: [userId], references: [id])
  repo           Repo     @relation(fields: [repoId], references: [id])

  @@index([originalRepoId])
}

model AuditLog {
  id        String   @id @default(cuid())
  repoId    String   @map("repo_id")
  userId    String   @map("user_id")
  action    String
  metadata  Json?
  timestamp DateTime @default(now())
  repo      Repo     @relation(fields: [repoId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@index([repoId, timestamp])
}

model Payment {
  id             String        @id @default(cuid())
  userId         String        @map("user_id")
  paystackSubId  String?       @map("paystack_sub_id")
  status         PaymentStatus @default(PENDING)
  planTier       PlanTier      @map("plan_tier")
  amount         Int
  currency       String        @default("NGN")
  reference      String?       @unique
  rawPayload     Json?         @map("raw_payload")
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")
  user           User          @relation(fields: [userId], references: [id])

  @@index([userId, status])
}

model Notification {
  id        String           @id @default(cuid())
  userId    String           @map("user_id")
  repoId    String?          @map("repo_id")
  type      NotificationType
  title     String
  body      String           @db.Text
  read      Boolean          @default(false)
  createdAt DateTime         @default(now()) @map("created_at")
  user      User             @relation(fields: [userId], references: [id])
  repo      Repo?            @relation(fields: [repoId], references: [id])

  @@index([userId, read])
}

model Follow {
  id         String   @id @default(cuid())
  followerId String   @map("follower_id")
  followingId String  @map("following_id")
  createdAt  DateTime @default(now()) @map("created_at")
  follower   User     @relation("follows_by_user", fields: [followerId], references: [id])
  following  User     @relation("followed_users", fields: [followingId], references: [id])

  @@unique([followerId, followingId])
}

model Template {
  id          String   @id @default(cuid())
  repoId      String   @map("repo_id")
  name        String
  description String   @db.Text
  priceNgn    Int      @default(400)
  createdAt   DateTime @default(now()) @map("created_at")
  repo        Repo     @relation(fields: [repoId], references: [id])
  purchases   TemplatePurchase[]
}

model TemplatePurchase {
  id          String   @id @default(cuid())
  templateId  String   @map("template_id")
  userId      String   @map("user_id")
  paymentId   String?  @map("payment_id")
  createdAt   DateTime @default(now()) @map("created_at")
  template    Template @relation(fields: [templateId], references: [id])
  user        User     @relation(fields: [userId], references: [id])
}

model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refreshToken      String? @db.Text @map("refresh_token")
  accessToken       String? @db.Text @map("access_token")
  expiresAt         Int?    @map("expires_at")
  tokenType         String? @map("token_type")
  scope             String?
  idToken           String? @db.Text @map("id_token")
  sessionState      String? @map("session_state")
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}
